# Feature Development Work Plan Template

This is a comprehensive execution plan for developing new features in the `tako` project. Follow each step precisely to ensure code quality, proper testing, and seamless integration.

## Pre-Development Setup

1. **Create Feature Branch**
   - Create branch using format: `feature/<issue-number>-<short-description>`
   - Switch to the new branch

2. **Establish Baseline**
   - Run full test suite to ensure clean starting state:
     ```bash
     go test -v -test.short ./...  # Quick functional tests
     go test -v ./...              # Full unit tests + linters
     go test -v -tags=e2e --local ./...  # Local E2E tests
     ```
   - Record test coverage in `issue_coverage.md` (read from `coverage.out` generated by `linter_test.go`)
   - Commit baseline coverage

## Analysis and Planning Phase

3. **Background Research**
   - Gather comprehensive information about:
     - The specific issue requirements
     - Related previous work and dependencies
     - Integration points with existing features
     - Overall project architecture context
   - Document findings in `issue_background.md`
   - Commit background analysis

4. **Question Formulation and Resolution**
   - List all technical questions and uncertainties
   - Use Gemini to evaluate code, designs, and issue background
   - Review Gemini's suggestions but validate against your understanding
   - Document agreed-upon answers

5. **Implementation Planning**
   - Create detailed plan with discrete phases in `issue_plan.md`
   - Each phase must leave codebase in healthy state (compiling + passing tests)
   - Include both implementation and testing components for each phase
   - Commit the plan

6. **Plan Review and Refinement**
   - Ask Gemini to critique the plan, providing:
     - Issue background documentation
     - Relevant code and design docs
     - The implementation plan
   - Address Gemini's questions and integrate feedback
   - Update plan and background as needed
   - Commit refined plan

## Implementation Phase

7. **Phase-by-Phase Development**
   - For each phase in the plan:
     - Implement the planned changes
     - Run full test suite:
       ```bash
       go test -v ./...
       go test -v -tags=e2e --local ./...
       ```
     - Fix any failing tests
     - Verify test coverage:
       - Overall coverage drop ≤ 1%
       - Individual function coverage drop ≤ 10%
       - Add tests if needed to maintain coverage
     - Update `issue_coverage.md` with current coverage
     - Mark phase complete in `issue_plan.md`
     - Commit phase completion

8. **Integration Testing**
   - Run comprehensive test suite:
     ```bash
     go test -v -tags=e2e --remote ./...  # Remote E2E tests
     act --container-architecture linux/amd64 -P ubuntu-latest=catthehacker/ubuntu:act-latest  # CI simulation
     ```
   - Fix any integration issues
   - Commit fixes

9. **Implementation Review**
   - Ask Gemini to review implementation, providing:
     - All background documentation
     - Implementation plan
     - Relevant tests and code
     - Design documents
   - If actionable feedback aligns with project goals:
     - Add new phases to plan
     - Return to step 7 for additional work
   - Commit any changes

## Finalization Phase

10. **Cleanup**
    - Delete temporary files: `issue_background.md`, `issue_coverage.md`, `issue_plan.md`
    - Commit cleanup

11. **Manual Verification**
    - Create step-by-step verification script under `test/scripts/` including:
      - Installing `tako` and `takotest` CLI tools
      - Using custom cache and work directories within current folder
      - Testing both local and remote modes
      - Output verification to ensure functionality
    - Run script in local mode until passing
    - Run script in remote mode to verify
    - Commit working changes

## Pull Request and Integration

12. **Create Pull Request**
    - Use conventional commit format for PR title
    - Include comprehensive testing instructions
    - Reference the issue on the last line (e.g., "Fixes #123")

13. **Monitor and Fix CI**
    - Wait 2 minutes, then check PR status
    - If automated checks fail:
      - Gather failure logs
      - Reproduce issues locally
      - Fix problems
      - Run full test suite locally:
        ```bash
        go test -v ./...
        go test -v -tags=e2e --local ./...
        ```
      - Commit and push fixes
      - Repeat until all checks pass

14. **Completion**
    - Report issue resolution once all checks pass

## Key Requirements

- **Testing**: All phases must maintain passing tests and adequate coverage
- **Commits**: Follow Conventional Commits specification
- **Code Quality**: All code must pass `gofmt` and linter checks
- **Documentation**: Update README.md for any new features/commands
- **Backward Compatibility**: Maintain compatibility for `tako.yml` schema changes

## Emergency Protocol

If repeating the same action multiple times without success:
1. Collect problem evidence
2. Consult Gemini for suggestions
3. Implement recommended solutions before proceeding