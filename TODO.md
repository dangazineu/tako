# E2E Test Framework Implementation Plan

This document outlines the finalized design and implementation plan for the new E2E test framework. It captures all key decisions and serves as the single source of truth for this task.

## 1. High-Level Goal & Current Status

**Goal:** Refactor the E2E test suite to be more robust, scalable, and capable of testing complex, real-world scenarios for the `tako run` command.

**Current Status:**
- The initial implementation of the `tako run` command is complete.
- The E2E test framework has been significantly refactored based on the plan below.
- All unit, integration, local E2E, and remote E2E tests are currently **passing** on the `feature/17-run-command` branch.
- The `scenarios.md` file, which was used for initial planning, has been merged into this document and deleted.

## 2. Key Architectural Decisions (The "Why")

This section documents the critical design choices made for the E2E framework.

### 2.1. The "Developer Workflow" Model for `takotest`

We have decided to use a unified **"Developer Workflow" Model** for the `takotest setup` command. This means:
1.  The tool *always* begins by generating a complete set of Git repositories on the local filesystem.
2.  If running in **remote mode**, it then creates corresponding empty repositories on GitHub and pushes the local contents to them.
3.  If running in **local mode**, it moves the generated Git repositories directly into the local cache structure.
4.  Finally, it prepares the `workDir` and `cacheDir` for the specific test run.

**Rationale:** This approach was chosen over a "State Simulation" model because it more accurately reflects a real developer's workflow, and it ensures that both local and remote tests are derived from the exact same Git-based foundation, reducing implementation drift between the two modes.

### 2.2. The `owner` as a Logical Identifier

The `tako.yml` files generated by `takotest` use a dynamic `owner` in the `dependents` list:
-   In `--local` mode: `dependents: [local/repo-b:main]`
-   In remote mode: `dependents: [tako-test/repo-b:main]`

**Rationale:** This is a critical design choice. The `owner/repo` string is a **logical identifier** that `tako` uses to construct its cache paths (`<cache-dir>/repos/<owner>/<repo>/<branch>`). It is not a direct filesystem path. Using a dynamic owner allows us to test `tako`'s two distinct resolution logics (the remote-first fetching logic and the local-only cache lookup logic) with the same binary and test environment definitions.

### 2.3. Declarative, Multi-Step Test Cases

The framework is built around two core structs:
-   `TestEnvironmentDef`: An owner-agnostic definition of a set of repositories and their files.
-   `TestCase`: A declarative, multi-step definition of a test, composed of `Setup` and `Test` phases, where each phase is a series of `Step`s (commands with expected outcomes).

**Rationale:** This declarative approach was chosen to make complex tests (like the Java binary incompatibility scenario) easy to define and understand directly from the test files, keeping the Go test runner (`e2e_test.go`) generic and simple.

### 2.4. Test Environment Dependencies

The E2E tests are designed to be run *within* an environment that has the necessary dependencies (like `git`, `java`, `mvn`) pre-installed.

**Rationale:** The test suite itself will not be responsible for installing these tools or managing containers. This simplifies the test code and makes the CI configuration (e.g., the `Dockerfile` or GitHub Actions workflow) the single source of truth for the test environment's dependencies. The tests will, however, perform prerequisite checks and fail with a clear error if a required tool is not found.

## 3. Finalized Plan of Action

### Phase 1: Core Framework Refactoring (Completed)

-   [x] **Update Cache Path Logic & Documentation:** The codebase and documentation have been updated to use the correct cache structure: `<cache-dir>/repos/<owner>/<repo>/<branch>`.
-   [x] **Refactor `cmd/takotest/internal/setup.go`:** The `setup` command has been refactored into a single, unified workflow.
-   [x] **Update `test/e2e/environments.go`:** The `TestEnvironmentDef` and `RepositoryDef` structs have been updated.
-   [x] **Refactor `e2e_test.go`:** The test runner has been refactored into a generic engine.

### Phase 2: Scenario Implementation (Next Steps)

-   [x] **Implement the Java Binary Incompatibility Scenario:** This is the immediate next task.
    *   [x] Create the new `TestEnvironmentDef` in `test/e2e/environments.go`.
    *   [x] Add the required Java and Maven template files to `test/e2e/templates/`.
    *   [x] Create the new multi-step `TestCase` in `test/e2e/modifying_test.go`.
-   [ ] **Implement Other Scenarios:**
    *   [ ] Add test cases for the "Status Check", "Dependency Update", and "Cache Cleaning" scenarios to provide broader coverage of `tako run`.
